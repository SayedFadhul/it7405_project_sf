{% extends "base.html" %}

{% block content %}
<section class="page-section">
  <div class="page-card-lg page-card-edit">
    <div class="page-card-header">
      <h2 class="page-card-title mb-1">Edit your review</h2>
      <p class="page-card-subtitle">
        Update your rating or comment. We appreciate your feedback and how it helps other customers.
      </p>
    </div>

    <form method="post" novalidate>
      {% csrf_token %}

      {% for field in form %}
      {% if field.name == "rating" %}
      <!-- Custom rating field with stars -->
      <div class="mb-3">
        <label class="form-label d-block">Rating</label>

        <!-- Hidden Django field (value is set by the stars) -->
        <div class="hidden-rating">
          {{ field }}
        </div>

        <!-- Our clickable stars (same as reviews.html) -->
        <div class="rating-stars" id="rating-stars">
          <span class="rating-star" data-value="1">★</span>
          <span class="rating-star" data-value="2">★</span>
          <span class="rating-star" data-value="3">★</span>
          <span class="rating-star" data-value="4">★</span>
          <span class="rating-star" data-value="5">★</span>
        </div>



        {% if field.errors %}
        <div class="text-danger small">
          {{ field.errors|striptags }}
        </div>
        {% endif %}
      </div>
      {% else %}
      <!-- Normal fields (full_name, email, comment) -->
      <div class="mb-3">
        <label class="form-label" for="{{ field.id_for_label }}">
          {{ field.label }}
        </label>
        {{ field }}
        {% if field.help_text %}
        <div class="form-helper">{{ field.help_text|safe }}</div>
        {% endif %}
        {% if field.errors %}
        <div class="text-danger small">
          {{ field.errors|striptags }}
        </div>
        {% endif %}
      </div>
      {% endif %}
      {% endfor %}

      <div class="d-flex justify-content-between align-items-center mt-3">
        <a href="{% url 'my_activity' %}" class="btn btn-outline-soft">
          Cancel
        </a>
        <button type="submit" class="btn btn-primary-gradient">
          Save changes
        </button>
      </div>
    </form>

    <!-- Same JS as reviews.html so stars work here too -->
    <script>
      (function () {
        const stars = document.querySelectorAll('#rating-stars .rating-star');
        const input = document.getElementById('id_rating');  // hidden Django field

        if (!input) {
          console.error("Rating input not found");
          return;
        }

        let currentRating = parseInt(input.value || "0");

        function updateStars(rating) {
          stars.forEach(star => {
            const value = parseInt(star.getAttribute('data-value'));
            if (value <= rating) {
              star.classList.add('active');
            } else {
              star.classList.remove('active');
            }
          });
        }

        // initial state from existing review rating
        updateStars(currentRating);

        stars.forEach(star => {
          const value = parseInt(star.getAttribute('data-value'));

          star.addEventListener('click', function () {
            currentRating = value;
            input.value = value;
            updateStars(currentRating);
          });

          star.addEventListener('mouseenter', function () {
            stars.forEach(s => {
              const v = parseInt(s.getAttribute('data-value'));
              s.classList.toggle('hovered', v <= value);
            });
          });

          star.addEventListener('mouseleave', function () {
            stars.forEach(s => s.classList.remove('hovered'));
          });
        });
      })();
    </script>

  </div>
</section>
{% endblock %}
